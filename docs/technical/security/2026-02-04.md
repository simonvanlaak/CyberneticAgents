# Security Audit Report - 2026-02-04

## Audit Summary
- Date: 2026-02-04
- Scope: `src/`, `main.py`, configs/secrets, data stores, CLI tooling/skills, security-critical docs.
- Baseline: `git rev-parse HEAD` => `bed7e9e4bb5c63d2565f32010ea6256f187f1604`.

## Tools Run
- `python3 -m pytest tests/ -v` (failed; see Test Results)
- `python3 -m pytest tests/memory/test_permissions.py -v` (passed)
- `python3 -m pip freeze` (captured for dependency inventory)
- OSV API query for direct `pyproject.toml` dependencies (no vulns returned)
- Manual CLI executor checks:
  - Unknown tool denied by RBAC
  - Secret redaction check with dummy token (no secret in logs)

## Test Results
- Full suite: 8 failed, 2 errors, 489 passed, 2 skipped.
- Failure pattern: SQLite `OperationalError: attempt to write a readonly database` during Casbin policy writes.
  - Examples:
    - `tests/services/test_system_skill_permissions_service.py::test_skill_grant_add_logs_audit`
    - `tests/services/test_system_skill_permissions_service.py::test_skill_grant_logs_audit_events`
- RBAC/VSM matrix: `tests/memory/test_permissions.py` passed (team/global/agent scope rules).

## Findings
1. **RBAC fallback allows tool access when enforcer import fails**
   - Severity: Medium
   - Impact: If `src.rbac.enforcer` is unavailable, `CliTool._check_permission` logs a warning and allows all tool access.
   - Status: Open
   - Location: `src/cyberagent/tools/cli_executor/cli_tool.py`

2. **CLI tool command logging can leak secrets passed as arguments**
   - Severity: Medium
   - Impact: `CliTool` logs the full command string; if a caller passes secrets as CLI args, they will be logged.
   - Status: Open
   - Location: `src/cyberagent/tools/cli_executor/cli_tool.py`

3. **RBAC bypass if `agent_id` is omitted**
   - Severity: Medium
   - Impact: `CliTool.execute` performs no permission checks when `agent_id` is `None`, allowing execution without RBAC.
   - Status: Open
   - Location: `src/cyberagent/tools/cli_executor/cli_tool.py`

4. **Security audit logs are not persisted to `data/security_logs.db`**
   - Severity: Low
   - Impact: Audit logging uses standard logging only; there is no durable audit log database as referenced in the audit plan.
   - Status: Open
   - Location: `src/cyberagent/services/audit.py`

5. **CLI tools image not pinned by digest**
   - Severity: Low
   - Impact: Supply-chain risk from unpinned base image (`node:22-slim`).
   - Status: Open
   - Location: `src/cyberagent/tools/cli_executor/Dockerfile.cli-tools`

## Manual Checks
- **Unknown tool deny-by-default**: `CliTool.execute("unknown_tool", agent_id="unknown_agent")` returned `not authorized`.
- **Secrets redaction**: A dummy secret token was set and used as `required_env`; error/log output did not contain the secret value.

## Data & Storage Security
- Persistent DBs found only under `data/`:
  - `data/CyberneticAgents.db`
- No `.db` files found outside `data/`.
- Logs are stored under `logs/` (non-DB).
- `data/security_logs.db`, `data/rbac.db`, and `data/skill_permissions.db` not present in this workspace snapshot.

## Dependency & Supply Chain
- Direct dependencies from `pyproject.toml` queried against OSV by name/version; no vulnerabilities returned.
- No lockfile present.
- Docker base image is not pinned by digest.

## Evidence Summary (Redacted)
- Full test suite executed and failed as above.
- RBAC/VSM matrix tests executed and passed.
- Dependency inventory captured via `pip freeze`.
- OSV query executed for direct dependencies.
- Deny-by-default tool execution and secret redaction checks executed.

## Ephemeral Artifacts Removed
- `.pytest_cache`

## Remediation Plan (Owner TBD)
1. Enforce deny-by-default even if RBAC import fails.
2. Remove or sanitize command logging in `CliTool` (avoid logging args that may include secrets).
3. Require `agent_id` for all CLI tool executions or enforce a safe default.
4. Decide on durable security audit log storage and document it.
5. Pin the CLI tools Docker image by digest for production builds.

