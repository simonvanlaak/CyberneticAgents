#!/usr/bin/env bash
set -euo pipefail

# Prefer venv if present so hooks use project deps
PYTHON_BIN="python3"
if [[ -x ".venv/bin/python" ]]; then
  PYTHON_BIN=".venv/bin/python"
fi
BASEDPYRIGHT_BIN="basedpyright"
if [[ -x ".venv/bin/basedpyright" ]]; then
  BASEDPYRIGHT_BIN=".venv/bin/basedpyright"
fi

# Staged Python files
staged_py_files=$(git diff --cached --name-only --diff-filter=ACM | rg '\.py$' || true)

staged_files=$(git diff --cached --name-only --diff-filter=ACM -- '*.py' || true)
line_count_fail=0
if [[ -n "${staged_files}" ]]; then
  while IFS= read -r file; do
    if [[ -f "${file}" ]]; then
      line_count=$(wc -l < "${file}" | tr -d ' ')
      if (( line_count > 1000 )); then
        echo "ERROR: ${file} has ${line_count} lines (limit is 1000)." >&2
        line_count_fail=1
      elif (( line_count > 700 )); then
        echo "WARNING: ${file} has ${line_count} lines (warning at 700)." >&2
      fi
    fi
  done <<< "${staged_files}"
fi

if (( line_count_fail != 0 )); then
  exit 1
fi

if [[ -n "${staged_py_files}" ]]; then
  echo "Running black --check on staged Python files..."
  for file in ${staged_py_files}; do
    ${PYTHON_BIN} -m black --check "${file}"
  done
  echo "Running ruff on staged Python files..."
  for file in ${staged_py_files}; do
    ${PYTHON_BIN} -m ruff check "${file}"
  done
  echo "Running basedpyright on staged Python files..."
  ${BASEDPYRIGHT_BIN} --pythonpath ${PYTHON_BIN} ${staged_py_files}
else
  echo "No staged Python files for black/ruff/basedpyright."
fi

# Staged test files only
staged_test_files=$(git diff --cached --name-only --diff-filter=ACM | rg '^tests/.*\.py$' || true)
coverage_anchor="tests/tools/test_cli_executor_coverage.py"
if [[ -n "${staged_test_files}" ]]; then
  if ! echo "${staged_test_files}" | rg -q "^${coverage_anchor}$"; then
    staged_test_files="${staged_test_files} ${coverage_anchor}"
  fi
fi

if [[ -n "${staged_test_files}" ]]; then
  staged_cov_targets=$(git diff --cached --name-only --diff-filter=ACM | rg '^src/.*\.py$' || true)
  cov_args=""
  if [[ -n "${staged_cov_targets}" ]]; then
    while IFS= read -r file; do
      module="${file%.py}"
      module="${module//\//.}"
      if [[ "${module}" == *-* ]]; then
        echo "Skipping coverage for path with hyphen: ${file}"
        continue
      fi
      cov_args+=" --cov=${module}"
    done <<< "${staged_cov_targets}"
    echo "Running pytest with coverage (min 25%) on staged test files..."
    ${PYTHON_BIN} -m pytest -v ${staged_test_files} ${cov_args} --cov-report=term-missing --cov-fail-under=25
  else
    echo "Running pytest on staged test files (no staged src files for coverage)..."
    ${PYTHON_BIN} -m pytest -v ${staged_test_files}
  fi
else
  echo "No staged test files for pytest."
fi
