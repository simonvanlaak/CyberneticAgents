# Unified MVP stack: Taiga + CyberneticAgents runtime
#
# Usage:
#   cp .env.example .env
#   # fill required secrets/placeholders in .env
#   docker compose up -d

services:
  taiga-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${TAIGA_DB_NAME:-taiga}
      POSTGRES_USER: ${TAIGA_DB_USER:-taiga}
      POSTGRES_PASSWORD: ${TAIGA_DB_PASSWORD:-change_me}
    volumes:
      - taiga_db:/var/lib/postgresql/data
    restart: unless-stopped

  taiga-redis:
    image: redis:7-alpine
    restart: unless-stopped

  taiga-rabbit:
    image: rabbitmq:3-alpine
    hostname: taiga-rabbit
    environment:
      RABBITMQ_DEFAULT_USER: ${TAIGA_RABBIT_USER:-taiga}
      RABBITMQ_DEFAULT_PASS: ${TAIGA_RABBIT_PASSWORD:-change_me}
    restart: unless-stopped

  taiga-back:
    image: taigaio/taiga-back:latest
    depends_on:
      - taiga-db
      - taiga-redis
      - taiga-rabbit
    environment:
      TAIGA_SECRET_KEY: ${TAIGA_SECRET_KEY:-change_me}
      TAIGA_SITES_SCHEME: http
      TAIGA_SITES_DOMAIN: ${TAIGA_SITES_DOMAIN:-localhost:${TAIGA_PUBLIC_PORT:-9000}}
      POSTGRES_DB: ${TAIGA_DB_NAME:-taiga}
      POSTGRES_USER: ${TAIGA_DB_USER:-taiga}
      POSTGRES_PASSWORD: ${TAIGA_DB_PASSWORD:-change_me}
      POSTGRES_HOST: taiga-db
      POSTGRES_PORT: 5432
      REDIS_HOST: taiga-redis
      REDIS_PORT: 6379
      RABBITMQ_USER: ${TAIGA_RABBIT_USER:-taiga}
      RABBITMQ_PASS: ${TAIGA_RABBIT_PASSWORD:-change_me}
      RABBITMQ_HOST: taiga-rabbit
      RABBITMQ_PORT: 5672
      EMAIL_BACKEND: django.core.mail.backends.console.EmailBackend
    volumes:
      - taiga_media:/taiga/media
      - taiga_static:/taiga/static
    restart: unless-stopped

  taiga-events:
    image: taigaio/taiga-events:latest
    depends_on:
      - taiga-rabbit
    environment:
      RABBITMQ_USER: ${TAIGA_RABBIT_USER:-taiga}
      RABBITMQ_PASS: ${TAIGA_RABBIT_PASSWORD:-change_me}
      RABBITMQ_HOST: taiga-rabbit
      RABBITMQ_PORT: 5672
    restart: unless-stopped

  taiga-front:
    image: taigaio/taiga-front:latest
    depends_on:
      - taiga-back
    ports:
      - "127.0.0.1:${TAIGA_PUBLIC_PORT:-9000}:80"
    restart: unless-stopped

  cyberagent:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - taiga-back
    env_file:
      - .env
    environment:
      CYBERAGENT_DB_URL: ${CYBERAGENT_DB_URL:-sqlite:///data/CyberneticAgents.db}
      CYBERAGENT_ACTIVE_TEAM_ID: ${CYBERAGENT_ACTIVE_TEAM_ID:-1}
    command: ["python", "-m", "src.cyberagent.cli.cyberagent", "serve"]
    volumes:
      - cyberagent_data:/app/data
      - cyberagent_logs:/app/logs
    restart: unless-stopped

volumes:
  taiga_db:
  taiga_media:
  taiga_static:
  cyberagent_data:
  cyberagent_logs:
